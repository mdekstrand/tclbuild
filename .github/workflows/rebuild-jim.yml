name: Rebuild JimTCL
on:
  push:
    branches:
    - main

concurrency:
  group: test-${{github.ref}}
  cancel-in-progress: true

jobs:
  linux:
    name: Build jimtcl for linux-${{matrix.arch}}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch:
        - x86_64
        # - x86
        - aarch64
        - armhf
        - armv7

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - uses: jirutka/setup-alpine@v1
      with:
        arch: ${{ matrix.arch }}
        branch: v3.17
        packages: build-base openssl tcl

    - name: Build custom Jim
      shell: alpine.sh {0}
      id: build-jim
      run: |
        tclsh build.tcl

    - name: Build default Jim
      shell: alpine.sh {0}
      id: build-jim-default
      if: ${{ matrix.arch == 'x86_64' }}
      run: |
        tclsh build.tcl -p default

    - name: Install signing deps
      run: sudo apt install -y expect minisign signify

    - name: Sign compiled files
      id: sign-jim
      run: |
        tclsh sigtool.tcl --sign dist/jim-*/jimsh-*
      env:
        SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

    - uses: actions/upload-artifact@v3
      with:
        name: jimsh-${{ steps.build-jim.outputs.build-tag }}
        path: dist/

  macos:
    name: Build jimtcl for Mac
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Dump TCL environment info
      run: |
        tclsh envinfo.tcl

    - name: Build custom Jim for Intel
      id: build-jim-intel
      run: |
        tclsh build.tcl -a x86_64

    - name: Build custom Jim for ARM
      id: build-jim-arm
      run: |
        tclsh build.tcl -a arm64

    - name: Build default Jim for Intel
      id: build-jim-default-intel
      run: |
        tclsh build.tcl -p default -a x86_64

    - name: Build default Jim for ARM
      id: build-jim-default-arm
      run: |
        tclsh build.tcl -p default -a arm64

    - uses: actions/upload-artifact@v3
      with:
        name: jimsh-macos
        path: dist/

  windows:
    name: Build jimtcl for Windows
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - uses: msys2/setup-msys2@v2
      with:
        update: true
        msystem: mingw32
        install: >-
          openssl
          mingw-w64-i686-gcc
          make
          tcl

    - name: Dump environment info
      shell: msys2 {0}
      run: |
        tclsh envinfo.tcl

    - name: Build custom Jim for Windows
      id: build-jim-custom
      shell: msys2 {0}
      run: |
        tclsh build.tcl

    - name: Build default Jim for Windows
      id: build-jim-default
      shell: msys2 {0}
      run: |
        tclsh build.tcl -p default

    - uses: actions/upload-artifact@v3
      with:
        name: jimsh-windows
        path: dist/
